---
title: "TCP粘包问题"
subtitle: ""
description: "TCP粘包是指发送方发送的若干包数据在接收方接收时粘成一包。这种情况的出现，会导致数据接收解析的混乱，使得应用层难以正确解析数据。"
date: 2025-01-01T13:55:55Z
author:      "Wayne"
image: ""
tags: ["TCP粘包"]
categories: ["Tech"]
---

## TCP 的基本特性

- 面向字节流：TCP 不关心应用层数据的边界，数据被看作一个连续的字节流。
- 可靠传输：通过序列号、确认应答、重传机制等保证数据的可靠性和顺序性。
- 流量控制与拥塞控制：通过调整传输速率防止网络拥堵和接收方溢出。

由于这些特性，TCP 在传输数据时不会保留应用层的消息边界，这直接导致了粘包和拆包的问题。

## 粘包(多个应用层数据包 PDU 粘成一个 TCP 数据包发送给接收方)

粘包是指多个应用层独立发送的数据包在传输过程中被合并为一个 TCP 数据包到达接收方，接收方无法区分这是一个还是多个数据包。

发生的原因：

1. 发送方发送数据过快：应用层多次小数据发送，TCP 将它们合并为一个大包发送，以提高传输效率。Nagle 算法：为了减少小包的数量，Nagle 算法会将多个小数据包合并为一个包发送。
2. 网络延迟和缓冲：TCP 的发送缓冲区和接收缓冲区会暂存数据，当缓冲区积累到一定程度或达到发送窗口时，才会一次性发送。

## 拆包(将接收缓存中的一堆字节码拆分还原成多个应用层数据包/PDU 发送给应用层)

- 靠长度：

  1.  如设计每一个 PDU 长度都是固定相同的。接收方从 TCP 连接接收的第一个字节算起，每隔该固定长度就拆分出一个 PDU。
  2.  如设计每一个 PDU 都有一个固定长度的 header,header 中包含该 PDU payload 的长度信息。接收方根据这个长度字段来判断 PDU 的长度，然后根据这个长度字段从接收缓存中读取出第一个对应长度的 PDU，同理取出第二个 PDU，以此类推。如 Mysql 协议

- 靠分隔符
  如 http 协议，在 PDU 之间加上特定的分隔符（如回车换行符），接收方根据这个分隔符来拆分数据。

## UDP没有粘包拆包问题

因为UDP是基于报文的，每个UDP数据包都是一个独立的消息，有固定的长度界限。