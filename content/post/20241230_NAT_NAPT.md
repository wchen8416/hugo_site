---
title: "NAT/NAPT"
subtitle: ""
description: "NAT（Network Address Translation，网络地址转换）是将IP数据报文头中的IP地址转换为另一个IP地址的过程。NAPT（Network Address Port Translation，网络地址端口转换）是基本地址转换的一种变形，它允许多个内部地址映射到同一个公有地址上，也可称之为“多对一地址转换”。NAPT同时映射IP地址和端口号：来自不同内部地址的数据报文的源地址可以映射到同一外部地址，但它们的端口号被转换为该地址的不同端口号，因而仍然能够共享同一地址，也就是“私网IP地址＋端口号”与“公网IP地址＋端口号”之间的转换。"
date: 2024-12-30T11:59:02Z
author:      "Wayne"
image: ""
tags: ["NAT", "NAPT"]
categories: ["Tech"]
---

## NAT

![alt text](/img/NAT.png)

## NAPT

NAPT（Network Address Port Translation，网络地址端口转换）是基本地址转换的一种变形，它允许多个内部地址映射到同一个公有地址上，也可称之为“多对一地址转换”。
NAPT 同时映射 IP 地址和端口号：来自不同内部地址的数据报文的源地址可以映射到同一外部地址，但它们的端口号被转换为该地址的不同端口号，因而仍然能够共享同一地址，也就是{{<rawhtml>}}<span style="color:red;">“私网 IP 地址＋端口号”与“公网 IP 地址＋端口号”之间的转换。</span>{{</rawhtml>}}

![alt text](/img/NAPT.png)

Note: 这个图有一个错误，Packet3 应该是 Src: 192.168.1.3:1111 而不是 192.168.1.2:3333。

三个带有内部地址的数据报文到达 NAT 设备，其中报文 1 和报文 2 来自同一个内部地址但有不同的源端口号，报文 1 和报文 3 来自不同的内部地址但具有相同的源端口号。通过 NAPT 映射，四个数据报的源 IP 地址都被转换到同一个外部地址，但每个数据报都被赋予了不同的源端口号，因而仍保留了报文之间的区别。当各报文的回应报文到达时，NAT 设备仍能够根据回应报文的目的 IP 地址和目的端口号来区别该报文应转发到的内部主机。  
采用 NAPT 可以更加充分地利用 IP 地址资源，实现更多内部网络主机对外部网络的同时访问。

目前，NAPT 支持两种不同的地址转换模式：

- Endpoint-Independent Mapping（不关心对端地址和端口转换模式）  
   该模式下，NAT 设备通过建立三元组（源地址、源端口号、协议类型）表项来进行地址分配和报文过滤。即，只要是来自相同源地址和源端口号的报文，不论其目的地址是否相同，通过 NAPT 映射后，其源地址和源端口号都被转换为同一个外部地址和端口号，{{<rawhtml>}}<span style="color:red;">并且 NAT 设备允许外部网络的主机通过该转换后的地址和端口来访问这些内部网络的主机。这种模式可以很好得支持位于不同 NAT 设备之后的主机间进行互访。</span>{{</rawhtml>}}
- Address and Port-Dependent Mapping（关心对端地址和端口转换模式）  
   该模式下，NAT 设备通过建立五元组（源地址、源端口号、协议类型、目的地址、目的端口号）表项为依据进行地址分配和报文过滤。即，对于来自相同源地址和源端口号的报文，若其目的地址和目的端口号不同，通过 NAPT 映射后，相同的源地址和源端口号将被转换为不同的外部地址和端口号，并且 NAT 设备只允许这些目的地址对应的外部网络的主机才可以通过该转换后的地址和端口来访问这些内部网络的主机。这种模式安全性好，但是不便于位于不同 NAT 设备之后的主机间进行互访。

## References

1. (https://www.h3c.com/cn/d_200812/624141_473262_0.htm)
